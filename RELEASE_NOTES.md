# リリースノート

## 2026-02-02

### 新機能

#### 1. ファイルローディング中のインジケータ実装

コンテンツとスキルマスターの読み込み中に、ユーザーフレンドリーなローディングインジケータを表示するようになりました。

**主な機能:**
- ローディングスピナーアニメーション
- 読み込み進捗の可視化（現在数/総数）
- プログレスバー表示
- リアルタイムでの進捗メッセージ更新

**技術詳細:**
- UIストアに `isLoading`、`loadingMessage`、`loadingProgress` 状態を追加
- `startLoading()`、`updateLoadingProgress()`、`stopLoading()` メソッドを実装
- 新規コンポーネント: `LoadingIndicator.vue`
- `contentStore.loadContents()` でボス単位の読み込み進捗を追跡
- `skillMasterStore.loadSkillMaster()` でスキルマスター読み込み状態を通知

#### 2. スマホレイアウト対応（ヘッダーの折りたたみ機能）

モバイル端末での使いやすさを向上させるため、ヘッダーメニューの折りたたみ機能を追加しました。

**主な機能:**
- モバイル端末でのみ表示される折りたたみボタン（▼/▲）
- 折りたたみ時はヘッダーの高さを最小化
- 折りたたみ時はメニューを非表示にし、タイムライン領域を拡大
- デスクトップでは常にメニューを表示（折りたたみボタン非表示）
- スムーズなアニメーション（transition-all duration-300）

**技術詳細:**
- UIストアに `headerCollapsed` 状態を追加
- `toggleHeaderCollapsed()` メソッドを実装
- Tailwind CSSのレスポンシブクラス（md:hidden、md:flex）を活用
- モバイル優先のレイアウト設計

### セキュリティ対応

#### OWASP準拠
- **ローディングインジケータ**:
  - エラーハンドリングを適切に実装し、読み込み失敗時も正しく状態をクリア
  - クライアント側のみの状態管理（セキュリティリスクなし）
  - XSS対策: ローディングメッセージはVueテンプレートで自動エスケープ

- **ヘッダー折りたたみ機能**:
  - クライアント側のみの状態管理（セキュリティリスクなし）
  - UI改善のみでデータ処理には影響なし

### 変更されたファイル

#### 新規作成
- `04_implementation/src/components/LoadingIndicator.vue` - ローディングインジケータコンポーネント

#### 更新
- `04_implementation/src/stores/uiStore.ts`
  - ローディング状態管理機能を追加
  - ヘッダー折りたたみ状態管理を追加

- `04_implementation/src/stores/contentStore.ts`
  - `loadContents()` にローディング進捗通知を追加
  - UIストアのインポートを追加

- `04_implementation/src/stores/skillMasterStore.ts`
  - `loadSkillMaster()` にローディング状態通知を追加
  - UIストアのインポートを追加

- `04_implementation/src/App.vue`
  - `LoadingIndicator` コンポーネントを追加
  - ローディング終了処理を `onMounted` に追加

- `04_implementation/src/components/AppHeader.vue`
  - モバイル用折りたたみボタンを追加
  - レスポンシブクラスを適用

- `課題管理表.md` - 完了済み課題を更新

### パフォーマンス改善

- ローディングインジケータにより、ユーザーは読み込み状況を把握可能
- モバイルでのヘッダー折りたたみにより、タイムライン表示領域が拡大
- ユーザー体験の向上

### 既知の問題

なし

---

## 2026-01-24

### 破壊的変更

#### タイムラインデータのミリ秒精度への完全移行
- **すべての時間データをミリ秒単位に変更しました**
- FFLogsのデータと完全一致する精度を実現（6.5秒 → 6530ms）
- 既存の秒単位データとの互換性はありません（データの再生成が必要）

### 新機能

#### ギミック拡張機能の実装
- **UI表示の強化**
  - 危険度（Severity）に基づく色分け表示
    - 低（low）= 青色、中（medium）= 黄色、高（high）= オレンジ、即死級（fatal）= 赤色
  - カテゴリアイコンの追加（全体攻撃🌊、タンクバスター🛡️、頭割り🤝など）
  - 拡張ツールチップでメタデータ表示（カテゴリ、危険度、軽減推奨度、ターゲット、説明、ギミック要素）

- **軽減計画の自動提案**
  - 必須軽減タイミングのハイライト（`mitigation: required` のギミックに赤いリングとアニメーション）
  - 無敵必須箇所の警告（`mitigation: invuln` のギミックに⚡アイコン表示）

- **ロール別ビュー**
  - フィルタパネルの追加（ヘッダー右側）
  - タンク向け、ヒーラー向け、DPS向けギミックのフィルタリング
  - カテゴリ、危険度、軽減推奨度による複合フィルタ

- **攻略ガイドの自動生成**
  - Markdown形式で攻略ガイドをエクスポート
  - フェーズごとにギミック情報を整理
  - メタデータテーブル、説明、ギミック要素を含む詳細なガイド

#### タイムライン表示の改善
- **デフォルトズームを2.5倍に変更** (1秒=25px)
  - より広いスケールでギミック同士の間隔が見やすく
- **キャスト終了位置に発動マーカーを追加**
  - 白い縦線でキャスト終了＝攻撃発動タイミングを明示
  - ホバー時に発動時刻をツールチップ表示

### 技術的改善

#### 時間管理の精度向上
- **型定義の更新**
  - `Content.duration`: 秒 → ミリ秒
  - `Phase.startTime/endTime`: 秒 → ミリ秒
  - `Gimmick.time/castDuration`: 秒 → ミリ秒
  - `BurstTiming.startTime/endTime`: 秒 → ミリ秒
  - `TimelineMemo.time`: 秒 → ミリ秒

- **時間フォーマット関数の追加**
  - `formatTime(timeMs)`: MM:SS.s 形式（例: "1:23.4"）
  - `formatSeconds(timeMs)`: 秒.s 形式（例: "23.4s"）
  - `formatSecondsPrecise(timeMs)`: 秒.sss 形式（デバッグ用）
  - `formatTimeDetailed(timeMs)`: M分S.s秒 形式

- **uiStoreの変換関数を更新**
  - `timeToPixel(timeMs)`: ミリ秒をピクセル位置に変換
  - `pixelToTime(pixel)`: ピクセル位置をミリ秒に変換

#### データ生成の改善
- **generate-timeline.jsをミリ秒精度に変更**
  - FFLogsのタイムスタンプをそのまま使用（丸め処理を削除）
  - フェーズ区切りをミリ秒単位で管理（120000ms = 120秒）
  - より正確なタイムライン生成が可能に

### データ

#### アルカディア零式3層のデータ更新
- ミリ秒精度でタイムラインを再生成
- メタデータを保持したまま時間精度のみ更新
- 97個のギミック中39個にメタデータ付与済み
- FFLogsとの誤差が30ms以下に改善（従来は最大100ms）

### セキュリティ対応

#### OWASP準拠
- 型安全性: TypeScriptの型システムで時間データの整合性を保証
- 入力値検証: ミリ秒単位の時間データは厳密に数値型で管理
- XSS対策: メタデータの説明文はVueテンプレートで自動エスケープ
- データ整合性: 時間精度の一貫性により計算誤差を排除

### 変更されたファイル

#### 新規作成
- `src/stores/gimmickFilterStore.ts` - フィルタ状態管理
- `src/utils/gimmickStyles.ts` - 色分けルール、アイコン、ラベル定義
- `src/utils/guideExporter.ts` - Markdownエクスポートロジック
- `src/components/timeline/GimmickFilterPanel.vue` - フィルタUIコンポーネント
- `src/components/ui/GimmickTooltip.vue` - 拡張ツールチップコンポーネント
- `01_docs/merge-metadata.js` - メタデータマージスクリプト
- `01_docs/check-precision.js` - タイムスタンプ精度確認スクリプト

#### 更新
- `src/types/content.ts` - すべての時間フィールドをミリ秒に変更
- `src/utils/timeFormat.ts` - ミリ秒対応のフォーマット関数を追加
- `src/stores/uiStore.ts` - 時間⇔ピクセル変換をミリ秒対応に
- `src/components/timeline/GimmickRow.vue` - 色分け、アイコン、ツールチップ、発動マーカー追加
- `src/components/timeline/TimeAxisRow.vue` - 目盛り間隔をミリ秒に変更
- `src/components/timeline/PhaseDividers.vue` - フェーズ最小時間を1000msに変更
- `src/components/AppHeader.vue` - フィルタパネルと攻略ガイドエクスポートボタン追加
- `01_docs/generate-timeline.js` - ミリ秒精度でデータ生成するように変更
- `04_implementation/public/data/contents/アルカディア・ヘビー級零式/3層.json` - ミリ秒精度で再生成

### 今後の予定

#### ミリ秒精度対応の残タスク
- 他の層（1層、2層、4層）のデータをミリ秒精度で再生成
- パーティスキルの時間管理をミリ秒に統一
- 編集モードでのギミック追加時の時間スナップをミリ秒対応

---

## 2026-01-22

### 新機能

#### スキル干渉のアラート表示
- ロールスキルが複数のメンバーで同時に使われている場合に干渉を検知
- 干渉があるスキルには赤い縁と警告アイコン（⚠️）を表示
- ツールチップで干渉しているメンバー名を確認できます
- 同じスキルの効果時間が重複している場合に警告されます

#### 軽減率グラフへのツールチップ追加
- 軽減率グラフにマウスオーバーすると、その時刻の軽減率を表示
- 物理軽減率と魔法軽減率を%で確認できます
- 時刻も「分:秒」形式で表示されます

#### スキル行の複数行化（レーンシステム）
- 各メンバーに4つのレーン（行）を追加し、スキルを複数行に配置可能に
- スキル追加・移動時に空いているレーンを自動選択
- リキャストタイム中に別のスキルを使用する際も干渉せず配置できます
- レーン番号（L2〜L4）を行頭に表示
- スキルの時間的な重複を自動検知し、最適なレーンに配置

#### 軽減率の無敵スキル対応
- タンクの無敵スキル（無敵受け）を「無敵」として扱えるようになりました
- Skill型にinvincibleプロパティを追加
- 無敵スキルがアクティブな時間帯はグラフに金色のハイライトを表示
- ツールチップで「⭐ 無敵」と表示
- 無敵時は軽減率を自動的に100%に設定

### バグ修正

#### パーティリストのスクロール同期の問題を修正
- 行頭とメンバーエリアの縦スクロールが同期するように修正
- スクロール無限ループを防止するフラグを実装
- 行頭をスクロールするとタイムライン側も連動してスクロール
- タイムライン側をスクロールすると行頭も連動してスクロール

#### タイムラインスクロールの不具合を修正
- タイムライン上でマウスホイールを使った際、横スクロールのみ発生するように修正
- MemberAreaコンポーネントのホイールイベントを親に委譲
- 通常のホイールスクロールを横スクロールに変換
- Shiftキー押下時はズーム機能（既存の動作を維持）

#### 同じスキル干渉時の軽減率加算バグを修正
- 同じスキルが複数メンバーで使われている場合、効果が重複カウントされないように修正
- skillIdごとにMapを使って重複を排除し、正確な軽減率を表示
- 異なるスキルの軽減率のみ加算されるように改善

### 改善

#### 軽減率グラフの視認性向上
- 物理と魔法で統一されたスケールを使用（両方の最大値を10の倍数に切り上げ）
- 10%ごとに補助線（グリッドライン）を表示
- 各補助線にパーセンテージのラベルを追加
- 軽減率が一目でわかるように視覚的に改善

#### スキル名のスクロール追従
- 行頭部分にposition: stickyを追加
- 横スクロール時にメンバー名が常に表示されるように固定
- タイムラインの操作性が向上

### 変更されたファイル

#### 新規作成
- `src/composables/useSkillInterference.ts` - スキル干渉検知ロジック
- `src/composables/useSkillLane.ts` - レーン選択ロジック

#### 更新
- `src/types/skill.ts` - invincibleプロパティを追加
- `src/types/party.ts` - SkillPlacement型にlaneプロパティを追加
- `src/stores/partyStore.ts` - スキル追加・更新時の自動レーン選択
- `src/components/timeline/MemberRow.vue` - 4レーン表示対応
- `src/components/timeline/MemberArea.vue` - scrollイベントとref公開、wheelイベント委譲
- `src/components/timeline-items/SkillBar.vue` - 干渉検知の統合、警告表示
- `src/components/timeline/MitigationGraph.vue` - マウスオーバーツールチップ、補助線、スケーリング、無敵ハイライト
- `src/composables/useMitigationAggregation.ts` - 重複スキル排除ロジック、無敵判定
- `src/components/Timeline.vue` - 行頭固定（position: sticky）、4レーン対応、スクロール同期、wheelイベント処理
- `RELEASE_NOTES.md` - リリースノート更新
- `課題管理表.md` - 完了済み課題の更新

### セキュリティ対応

#### OWASP準拠
- 入力値検証: スキル配置IDによる干渉検知は型安全に実装されています
- XSS対策: ツールチップ表示はVueのテンプレート構文で自動エスケープされます
- データ整合性: Map構造を使用した重複排除により、データの正確性を保証
- 型安全性: TypeScriptの型システムでレーン番号を厳密に管理（0〜3の範囲）
- データ検証: 無敵フラグはboolean型で厳密に管理

---

## 2026-01-21

### 新機能

#### スキルのドラッグ時に垂直線を表示
- スキルをドラッグする際、開始位置（黄色の垂直線）と終了位置（青色の垂直線）が表示されるようになりました
- これにより、スキルの配置をより正確に行えるようになります

#### パーティスキルの効果情報の表示
- すべてのスキルに物理軽減率、魔法軽減率、バフ効果の情報を追加しました
- スキルバーにマウスオーバーすると、ツールチップで効果情報が確認できます
  - 例: 「ランパート (90秒) 物理軽減20%, 魔法軽減20%」

#### パーティスキルの効果集計
- タイムライン上でパーティ全体の軽減効果を自動集計する機能を追加しました
- メンバーエリアの先頭に物理軽減（青色）と魔法軽減（紫色）のエリアグラフを表示
- 1秒単位でリアルタイムに軽減率を計算・表示
- スキルの配置を変更すると、集計グラフも自動的に更新されます

#### スキルのキャストタイム、リキャストタイムの表示
- スキルにキャストタイムとリキャストタイムを追加しました
- キャストタイム: 黄色の縁とピンク系の内部で表示（スキル発動前の準備時間）
- 効果時間: 既存のカラフルなバーで表示（スキルが効果を発揮する時間）
- リキャストタイム: グレーの半透明で表示（再使用までの待機時間）
- スキルの状態が視覚的にわかりやすくなりました

### 改善

#### 課題管理表の整理
- 完了済みの課題を「完了済み課題」セクションに移動しました
- 重複していた古い課題を削除しました
- 未着手の課題を優先度別に整理しました

### セキュリティ対応

#### OWASP準拠
- 入力値検証: スキルの効果情報はJSONで定義され、型安全に管理されています
- データ整合性: 効果情報はオプショナルフィールドとして定義し、存在しない場合でも安全に動作します

### 変更されたファイル

#### 新規作成
- `src/components/ui/SkillDragLines.vue` - スキルドラッグ時の垂直線表示コンポーネント
- `src/composables/useMitigationAggregation.ts` - 軽減効果集計ロジック
- `src/components/timeline/MitigationGraph.vue` - 軽減効果グラフ表示コンポーネント

#### 更新
- `src/types/skill.ts` - Skill型に効果情報フィールド（physicalMitigation, magicalMitigation, buffPower）とcastTimeを追加
- `src/stores/uiStore.ts` - スキルドラッグ中の位置情報を管理する状態と関数を追加
- `src/components/Timeline.vue` - SkillDragLinesコンポーネントを統合、軽減効果集計行のヘッダーを追加
- `src/components/timeline/MemberArea.vue` - 軽減効果集計グラフを統合
- `src/components/timeline-items/SkillBar.vue` - スキルドラッグ時の垂直線位置設定、効果情報表示、キャスト/リキャストタイム表示を追加
- `public/data/skills/jobs.json` - 全スキルに効果情報とcastTimeを設定
- `課題管理表.md` - 完了済み課題の整理と更新

### 今後の予定

#### 優先度：中
- パーティメンバー間でのスキル干渉のアラート

#### 優先度：低
- スキル名をスクロールに追従させる機能
